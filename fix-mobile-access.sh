#!/bin/bash

echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø —Å –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤..."

# 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx..."
sudo systemctl stop nginx

# 2. –ö–æ–ø–∏—Ä—É–µ–º HTTP-—Å–æ–≤–º–µ—Å—Ç–∏–º—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üìù –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTTP-—Å–æ–≤–º–µ—Å—Ç–∏–º—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx..."
sudo cp nginx-sherdoc-http.conf /etc/nginx/sites-available/sherdoc.kg

# 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx..."
sudo nginx -t

if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
    
    # 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx..."
    sudo systemctl start nginx
    sudo systemctl enable nginx
    
    # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
    sudo systemctl status nginx --no-pager
    pm2 status
    
    # 6. –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç—ã –≤ —Ñ–∞–π—Ä–≤–æ–ª–µ
    echo "üîì –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–∞–π—Ä–≤–æ–ª..."
    sudo ufw allow 80
    sudo ufw allow 443
    sudo ufw allow 4000
    sudo ufw --force enable
    
    echo ""
    echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!"
    echo "üåê –°–∞–π—Ç —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å–∞–º:"
    echo "   - http://sherdoc.kg (–æ—Å–Ω–æ–≤–Ω–æ–π)"
    echo "   - http://sherdoc.kg:4000 (–ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é)"
    echo "   - https://sherdoc.kg (–µ—Å–ª–∏ SSL –Ω–∞—Å—Ç—Ä–æ–µ–Ω)"
    echo ""
    echo "üì± –¢–µ–ø–µ—Ä—å —Å–∞–π—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö!"
    echo ""
    echo "üîç –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
    echo "   - curl -I http://sherdoc.kg"
    echo "   - pm2 logs sherdoc-kg"
    echo "   - sudo nginx -t"
    
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx!"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª: /etc/nginx/sites-available/sherdoc.kg"
    exit 1
fi

