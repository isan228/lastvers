<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–∞–Ω–µ–ª—å —Å—É–¥—å–∏ ‚Äî Sherdoc</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #111 60%, #e10600 100%);
      color: #fff;
      min-height: 100vh;
    }
    .navbar {
      background: rgba(24, 24, 24, 0.9);
      backdrop-filter: blur(10px);
    }
    .card {
      background: rgba(24, 24, 24, 0.8);
      border: 1px solid #333;
      border-radius: 15px;
    }
    .btn-danger {
      background: #e10600;
      border: none;
    }
    .btn-danger:hover {
      background: #b00500;
    }
    .scoreboard {
      background: #000;
      border: 3px solid #e10600;
      border-radius: 10px;
      padding: 20px;
      font-family: 'Courier New', monospace;
      font-size: 24px;
      text-align: center;
    }
    .fighter-name {
      font-weight: bold;
      color: #fff;
    }
    .score {
      font-size: 48px;
      font-weight: bold;
      color: #e10600;
    }
    .round-info {
      color: #ccc;
      font-size: 18px;
    }
    .timer {
      font-size: 36px;
      color: #00ff00;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">üèÜ Sherdoc - –ü–∞–Ω–µ–ª—å —Å—É–¥—å–∏</a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3" id="user-info">–°—É–¥—å—è: –ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <div class="col-md-8">
        <div class="card mb-4">
          <div class="card-header">
            <h4>üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–æ</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">–ë–æ–µ—Ü 1:</label>
                  <input type="text" class="form-control" id="fighter1-name" placeholder="–ò–º—è –±–æ–π—Ü–∞">
                </div>
                <div class="mb-3">
                  <label class="form-label">–°—á–µ—Ç –±–æ–π—Ü–∞ 1:</label>
                  <input type="number" class="form-control" id="fighter1-score" value="0" min="0">
                </div>
                <div class="mb-3">
                  <button class="btn btn-success w-100" onclick="selectWinner(1)">üëë –ü–æ–±–µ–¥–∏—Ç–µ–ª—å 1</button>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">–ë–æ–µ—Ü 2:</label>
                  <input type="text" class="form-control" id="fighter2-name" placeholder="–ò–º—è –±–æ–π—Ü–∞">
                </div>
                <div class="mb-3">
                  <label class="form-label">–°—á–µ—Ç –±–æ–π—Ü–∞ 2:</label>
                  <input type="number" class="form-control" id="fighter2-score" value="0" min="0">
                </div>
                <div class="mb-3">
                  <button class="btn btn-success w-100" onclick="selectWinner(2)">üëë –ü–æ–±–µ–¥–∏—Ç–µ–ª—å 2</button>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">–í—Ä–µ–º—è –±–æ—è (—Å–µ–∫):</label>
                  <input type="number" class="form-control" id="round-time" value="180" min="30" max="600">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">–°—Ç–∞—Ç—É—Å –±–æ—è:</label>
                  <select class="form-select" id="fight-status">
                    <option value="preparing">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</option>
                    <option value="fighting">–ò–¥–µ—Ç –±–æ–π</option>
                    <option value="break">–ü–µ—Ä–µ—Ä—ã–≤</option>
                    <option value="finished">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button class="btn btn-warning" onclick="resetScoreboard()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h5>üì∫ –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">–°—Å—ã–ª–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–æ:</p>
            <div class="input-group mb-3">
              <input type="text" class="form-control" id="public-link" readonly value="http://localhost:4000/scoreboard.html">
              <button class="btn btn-outline-secondary" onclick="copyLink()">üìã</button>
            </div>
            <div class="mb-2">
              <h6>–ü–∞–Ω–µ–ª–∏ —Å—É–¥–µ–π:</h6>
              <div class="row">
                <div class="col-6 mb-2">
                  <a href="/judge1.html" class="btn btn-danger w-100">
                    <i class="bi bi-person-badge"></i> –°—É–¥—å—è 1
                  </a>
                </div>
                <div class="col-6 mb-2">
                  <a href="/judge2.html" class="btn btn-success w-100">
                    <i class="bi bi-person-badge"></i> –°—É–¥—å—è 2
                  </a>
                </div>
                <div class="col-6 mb-2">
                  <a href="/judge3.html" class="btn btn-warning w-100">
                    <i class="bi bi-person-badge"></i> –°—É–¥—å—è 3
                  </a>
                </div>
                <div class="col-6 mb-2">
                  <a href="/judge4.html" class="btn btn-info w-100">
                    <i class="bi bi-person-badge"></i> –°—É–¥—å—è 4
                  </a>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <h6>–¢–∞–±–ª–æ –¥–ª—è —Å—É–¥–µ–π:</h6>
              <div class="row">
                <div class="col-6 mb-2">
                  <a href="/scoreboard1.html" class="btn btn-outline-danger w-100" target="_blank">
                    <i class="bi bi-1-circle"></i> –¢–∞–±–ª–æ 1
                  </a>
                </div>
                <div class="col-6 mb-2">
                  <a href="/scoreboard2.html" class="btn btn-outline-success w-100" target="_blank">
                    <i class="bi bi-2-circle"></i> –¢–∞–±–ª–æ 2
                  </a>
                </div>
                <div class="col-6 mb-2">
                  <a href="/scoreboard3.html" class="btn btn-outline-warning w-100" target="_blank">
                    <i class="bi bi-3-circle"></i> –¢–∞–±–ª–æ 3
                  </a>
                </div>
                <div class="col-6 mb-2">
                  <a href="/scoreboard4.html" class="btn btn-outline-info w-100" target="_blank">
                    <i class="bi bi-4-circle"></i> –¢–∞–±–ª–æ 4
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–æ -->
    <div class="card mt-4">
      <div class="card-header">
        <h5>üì∫ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–æ</h5>
      </div>
      <div class="card-body">
        <div class="scoreboard" id="scoreboard-preview">
          <div class="row">
            <div class="col-5">
              <div class="fighter-name" id="preview-fighter1">–ë–æ–µ—Ü 1</div>
              <div class="score" id="preview-score1">0</div>
            </div>
            <div class="col-2">
              <div class="round-info" id="preview-round">–†–∞—É–Ω–¥ 1</div>
              <div class="timer" id="preview-timer">3:00</div>
            </div>
            <div class="col-5">
              <div class="fighter-name" id="preview-fighter2">–ë–æ–µ—Ü 2</div>
              <div class="score" id="preview-score2">0</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function checkAuth() {
      const auth = localStorage.getItem('judge-auth');
      const role = localStorage.getItem('judge-role');
      const user = localStorage.getItem('judge-user');
      
      if (!auth || role !== 'judge') {
        window.location.href = '/judge-login.html';
        return;
      }
      
      document.getElementById('user-info').textContent = `–°—É–¥—å—è: ${user}`;
    }
    
    // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    function logout() {
      localStorage.removeItem('judge-auth');
      localStorage.removeItem('judge-user');
      localStorage.removeItem('judge-role');
      window.location.href = '/judge-login.html';
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–æ
    function updateScoreboard() {
      const data = {
        fighter1: {
          name: document.getElementById('fighter1-name').value || '–ë–æ–µ—Ü 1',
          score: parseInt(document.getElementById('fighter1-score').value) || 0
        },
        fighter2: {
          name: document.getElementById('fighter2-name').value || '–ë–æ–µ—Ü 2',
          score: parseInt(document.getElementById('fighter2-score').value) || 0
        },
        round: 1, // –£–±–∏—Ä–∞–µ–º —Ä–∞—É–Ω–¥—ã
        roundTime: parseInt(document.getElementById('round-time').value),
        status: document.getElementById('fight-status').value
      };
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      fetch('/api/scoreboard/update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          updatePreview();
          showNotification('–¢–∞–±–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
        } else {
          showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–æ', 'error');
        }
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–æ', 'error');
      });
    }
    
    // –í—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    function selectWinner(fighterNumber) {
      const data = {
        fighter1: {
          name: document.getElementById('fighter1-name').value || '–ë–æ–µ—Ü 1',
          score: parseInt(document.getElementById('fighter1-score').value) || 0
        },
        fighter2: {
          name: document.getElementById('fighter2-name').value || '–ë–æ–µ—Ü 2',
          score: parseInt(document.getElementById('fighter2-score').value) || 0
        },
        round: 1,
        roundTime: parseInt(document.getElementById('round-time').value),
        status: 'finished',
        winner: fighterNumber,
        showWinner: true
      };
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      fetch('/api/scoreboard/update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          updatePreview();
          showNotification(`–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: –ë–æ–µ—Ü ${fighterNumber}!`, 'success');
          
          // –ß–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ —É–±–∏—Ä–∞–µ–º –ø–æ–∫–∞–∑ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
          setTimeout(function() {
            const normalData = {
              fighter1: data.fighter1,
              fighter2: data.fighter2,
              round: 1,
              roundTime: data.roundTime,
              status: 'finished',
              winner: fighterNumber,
              showWinner: false
            };
            
            fetch('/api/scoreboard/update', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(normalData)
            });
          }, 10000);
        } else {
          showNotification('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è', 'error');
        }
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è', 'error');
      });
    }
    
    // –°–±—Ä–æ—Å —Ç–∞–±–ª–æ
    function resetScoreboard() {
      document.getElementById('fighter1-name').value = '';
      document.getElementById('fighter2-name').value = '';
      document.getElementById('fighter1-score').value = 0;
      document.getElementById('fighter2-score').value = 0;
      document.getElementById('round-time').value = 180;
      document.getElementById('fight-status').value = 'preparing';
      
      updateScoreboard();
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    function updatePreview() {
      document.getElementById('preview-fighter1').textContent = 
        document.getElementById('fighter1-name').value || '–ë–æ–µ—Ü 1';
      document.getElementById('preview-fighter2').textContent = 
        document.getElementById('fighter2-name').value || '–ë–æ–µ—Ü 2';
      document.getElementById('preview-score1').textContent = 
        document.getElementById('fighter1-score').value;
      document.getElementById('preview-score2').textContent = 
        document.getElementById('fighter2-score').value;
      document.getElementById('preview-round').textContent = 
        '–ë–æ–π';
      
      const time = parseInt(document.getElementById('round-time').value);
      const minutes = Math.floor(time / 60);
      const seconds = time % 60;
      document.getElementById('preview-timer').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
    function copyLink() {
      const linkInput = document.getElementById('public-link');
      linkInput.select();
      linkInput.setSelectionRange(0, 99999);
      document.execCommand('copy');
      showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
    }
    
    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
      notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    
    // –î–µ–±–∞—É–Ω—Å –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    let updateTimeout;
    function debouncedUpdate() {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(function() {
        updatePreview();
        updateScoreboard();
      }, 500); // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ 500–º—Å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    }
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —Ç–∞–±–ª–æ
    document.addEventListener('input', function() {
      updatePreview();
      debouncedUpdate();
    });
    document.addEventListener('change', function() {
      updatePreview();
      debouncedUpdate();
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    checkAuth();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
