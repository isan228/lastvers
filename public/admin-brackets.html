<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω: –¢—É—Ä–Ω–∏—Ä–Ω—ã–µ —Å–µ—Ç–∫–∏ ‚Äî Sherdoc</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #111 60%, #e10600 100%);
      color: #fff;
      min-height: 100vh;
    }
    .admin-card {
      background: #181818cc;
      border-radius: 18px;
      box-shadow: 0 4px 24px #e1060033;
      padding: 2.5rem 2rem 2rem 2rem;
      width: 100%;
      max-width: 1000px;
      margin: 3rem auto;
    }
    .bracket-section {
      background: #222;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      padding: 1.5rem;
    }
    .fighter-list {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .fighter-item {
      background: #181818;
      border-radius: 8px;
      padding: 0.7rem 1.2rem;
      color: #fff;
      border: 2px solid #e10600;
      cursor: pointer;
      transition: background 0.2s, border 0.2s;
      user-select: none;
    }
    .fighter-item.selected {
      background: #e10600;
      color: #fff;
      border: 2px solid #fff;
    }
    .bracket-container {
      display: flex;
      gap: 2rem;
      overflow-x: auto;
      padding: 1rem 0;
      min-height: 400px;
    }
    .bracket-round {
      min-width: 200px;
      background: #222;
      border-radius: 10px;
      padding: 1rem;
      border: 2px solid #444;
    }
    .bracket-round h4 {
      color: #e10600;
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }
    .bracket-match {
      background: #181818;
      border: 2px solid #444;
      border-radius: 8px;
      margin-bottom: 1rem;
      padding: 0.5rem;
      min-height: 60px;
      position: relative;
    }
    .bracket-fighter {
      background: #333;
      border: 1px solid #666;
      border-radius: 5px;
      padding: 0.5rem;
      margin: 0.25rem 0;
      cursor: grab;
      transition: all 0.2s;
      user-select: none;
    }
    .bracket-fighter:hover {
      background: #444;
      border-color: #e10600;
    }
    .bracket-fighter.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    .bracket-fighter.winner {
      background: #e10600;
      border-color: #fff;
      color: #fff;
      font-weight: bold;
    }
    .bracket-fighter.by {
      background: #666;
      color: #999;
      font-style: italic;
    }
    .bracket-fighter.empty-slot {
      background: transparent;
      border: 2px dashed #666;
      color: #999;
      font-style: italic;
      cursor: pointer;
    }
    .bracket-fighter.empty-slot:hover {
      border-color: #e10600;
      background: #e1060011;
    }
    .bracket-fighter.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    .bracket-match.drag-over {
      border-color: #e10600;
      background: #e1060011;
    }
    .bracket-fighter.drag-over {
      border-color: #e10600;
      background: #e1060011;
    }
    .bracket-match.completed {
      border-color: #28a745;
      background: linear-gradient(135deg, #222 0%, #1a3d1a 100%);
    }
    .bracket-match.completed .bracket-fighter {
      opacity: 0.7;
    }
    .winner-buttons {
      margin-top: 10px;
      text-align: center;
    }
    .winner-buttons .btn {
      font-size: 0.8rem;
      padding: 0.3rem 0.6rem;
    }
    .match-result {
      text-align: center;
      font-size: 0.9rem;
      color: #e10600;
      font-weight: bold;
      margin: 0.25rem 0;
    }
    .drag-over {
      border-color: #e10600 !important;
      background: #e1060033 !important;
    }
    .btn-generate {
      background: #e10600;
      color: #fff;
      border: none;
      font-weight: 600;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    .btn-generate:hover {
      background: #b00500;
    }
    .btn-save {
      background: #222;
      color: #e10600;
      border: none;
      font-weight: 600;
      border-radius: 10px;
      margin-top: 1rem;
    }
    .btn-save:hover {
      background: #e10600;
      color: #fff;
    }

    /* Improved Bracket Visualization Styles */
    #bracket-visual {
      overflow-x: auto;
      padding: 2rem 0;
      scrollbar-width: thin;
      scrollbar-color: #e10600 #222;
      background: #111;
      border-radius: 10px;
      position: relative;
    }
    
    .bracket-wrapper {
      position: relative;
      min-height: 600px;
      padding: 2rem;
    }
    
    .bracket-container {
      display: flex;
      gap: 3rem;
      align-items: flex-start;
      min-width: fit-content;
    }
    
    .round {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      min-width: 250px;
    }
    
    .round-title {
      text-align: center;
      color: #e10600;
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .match {
      position: relative;
      background: #181818;
      border-radius: 12px;
      padding: 1rem;
      border: 2px solid #333;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .match:hover {
      border-color: #e10600;
      box-shadow: 0 6px 20px rgba(225, 6, 0, 0.2);
    }
    
    .match.completed {
      border-color: #28a745;
      background: #1a2e1a;
    }
    
    .fighter-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.8rem;
      margin: 0.3rem 0;
      background: #222;
      border-radius: 8px;
      border: 1px solid #444;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }
    
    .fighter-item:hover {
      background: #333;
      border-color: #e10600;
    }
    
    .fighter-item.winner {
      background: #e10600;
      color: #fff;
      border-color: #fff;
      font-weight: 600;
    }
    
    .fighter-item.bye {
      color: #777;
      border-style: dashed;
      justify-content: center;
      background: #111;
    }
    
    .fighter-item button {
      flex-shrink: 0;
      margin-left: 0.5rem;
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
    }
    
    /* SVG Connectors */
    svg.connectors {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .connector-line {
      stroke: #e10600;
      stroke-width: 2;
      fill: none;
      stroke-dasharray: 5,5;
      animation: dash 2s linear infinite;
    }
    
    @keyframes dash {
      to {
        stroke-dashoffset: -10;
      }
    }
    .match:last-child:nth-child(odd) .line-v {
      display: none;
    }
    .round:last-child .connector {
      display: none;
    }

    .bronze-container {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #222;
      border-radius: 10px;
    }

    #sidebar {
      width: 64px;
      background: #181818cc;
      transition: width 0.3s;
      overflow: visible;
      z-index: 10;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      box-shadow: 2px 0 16px #0002;
    }
    #sidebar .btn {
      text-align: left;
      padding-left: 1.2rem;
      font-size: 1.08rem;
      background: none;
      border: none;
      color: #fff;
      width: 100%;
      transition: background 0.2s, color 0.2s;
      position: relative;
    }
    #sidebar .btn i {
      font-size: 1.3rem;
      vertical-align: middle;
      transition: color 0.2s;
    }
    #sidebar .btn span {
      display: none;
      margin-left: 1.1rem;
      white-space: nowrap;
      transition: opacity 0.2s, margin 0.2s;
      opacity: 0;
    }
    #sidebar:hover, #sidebar:focus-within {
      width: 300px;
      box-shadow: 0 8px 32px #e1060066;
    }
    #sidebar:hover .btn span, #sidebar:focus-within .btn span {
      display: inline;
      opacity: 1;
      margin-left: 1.1rem;
    }
    #sidebar .btn:hover, #sidebar .btn:focus, #sidebar .btn.active {
      background: #e10600;
      color: #fff;
    }
    @media (max-width: 991px) {
      #sidebar { width: 100vw; position: static; }
      #sidebar .btn span { display: inline !important; opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="d-flex" style="min-height:100vh;">
    <nav id="sidebar" class="bg-dark" style="position:relative; z-index:10;">
      <ul class="nav flex-column pt-4" style="height:100vh;">
        <li class="nav-item mb-2"><button class="btn admin-btn w-100" title="–ë–æ–π—Ü—ã" onclick="location.href='/admin-fighters.html'"><i class="bi bi-person-fill"></i><span class="ms-3">–ë–æ–π—Ü—ã</span></button></li>
        <li class="nav-item mb-2"><button class="btn admin-btn w-100" title="–¢—Ä–µ–Ω–µ—Ä—ã" onclick="location.href='/admin-coaches.html'"><i class="bi bi-people-fill"></i><span class="ms-3">–¢—Ä–µ–Ω–µ—Ä—ã</span></button></li>
        <li class="nav-item mb-2"><button class="btn admin-btn w-100" title="–í–∏–¥—ã —Å–ø–æ—Ä—Ç–∞" onclick="location.href='/admin-sports.html'"><i class="bi bi-award-fill"></i><span class="ms-3">–í–∏–¥—ã —Å–ø–æ—Ä—Ç–∞</span></button></li>
        <li class="nav-item mb-2"><button class="btn admin-btn w-100" title="–ù–æ–≤–æ—Å—Ç–∏" onclick="location.href='/admin-news.html'"><i class="bi bi-newspaper"></i><span class="ms-3">–ù–æ–≤–æ—Å—Ç–∏</span></button></li>
        <li class="nav-item mb-2"><button class="btn admin-btn w-100" title="–¢—É—Ä–Ω–∏—Ä—ã" onclick="location.href='/admin-tournaments.html'"><i class="bi bi-trophy-fill"></i><span class="ms-3">–¢—É—Ä–Ω–∏—Ä—ã</span></button></li>
        <li class="nav-item mb-2"><button class="btn admin-btn w-100" title="–¢—É—Ä–Ω–∏—Ä–Ω—ã–µ —Å–µ—Ç–∫–∏" onclick="location.href='/admin-brackets.html'"><i class="bi bi-diagram-3-fill"></i><span class="ms-3">–¢—É—Ä–Ω–∏—Ä–Ω—ã–µ —Å–µ—Ç–∫–∏</span></button></li>
        <li class="nav-item mb-2"><button class="btn admin-btn w-100" title="–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ç–∫–∏" onclick="location.href='/admin-brackets-list.html'"><i class="bi bi-archive-fill"></i><span class="ms-3">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ç–∫–∏</span></button></li>
        <li class="nav-item mb-2"><button class="btn admin-btn w-100" title="–ö–ª—É–±—ã" onclick="alert('–°–∫–æ—Ä–æ!')"><i class="bi bi-building"></i><span class="ms-3">–ö–ª—É–±—ã</span></button></li>
        <li class="nav-item mt-auto mb-2"><button class="btn logout-btn w-100" id="logout"><i class="bi bi-box-arrow-right"></i><span class="ms-3">–í—ã–π—Ç–∏</span></button></li>
      </ul>
    </nav>
    <div class="admin-card">
      <h2 class="mb-4">–¢—É—Ä–Ω–∏—Ä–Ω—ã–µ —Å–µ—Ç–∫–∏</h2>
      <div class="bracket-section mb-4">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">–¢—É—Ä–Ω–∏—Ä</label>
            <select class="form-select" id="select-tournament"></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">–í–∏–¥ —Å–ø–æ—Ä—Ç–∞</label>
            <select class="form-select" id="select-sport"></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">–í–µ—Å (–∫–≥)</label>
            <input type="number" class="form-control" id="select-weight" min="30" max="200" step="1" value="70">
          </div>
          <div class="col-md-3">
            <label class="form-label">–ü–æ–ª</label>
            <select class="form-select" id="select-gender">
              <option value="–º—É–∂—Å–∫–æ–π">–ú—É–∂—Å–∫–æ–π</option>
              <option value="–∂–µ–Ω—Å–∫–∏–π">–ñ–µ–Ω—Å–∫–∏–π</option>
            </select>
          </div>
        </div>
        <button class="btn btn-generate w-100 mt-3" id="load-fighters">–ü–æ–∫–∞–∑–∞—Ç—å –±–æ–π—Ü–æ–≤</button>
      </div>
      <div id="fighters-block" style="display:none;">
        <h5>–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ç—É—Ä–Ω–∏—Ä–∞:</h5>
        <div class="fighter-list" id="fighter-list"></div>
        <button class="btn btn-generate" id="generate-bracket">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–∫—É</button>
      </div>
      <div id="bracket-block" style="display:none;">
        <h5>–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–µ—Ç–∫–∞:</h5>
        <div class="bracket-wrapper">
          <svg class="connectors" id="bracket-connectors"></svg>
          <div class="bracket-container" id="bracket-visual"></div>
        </div>
        <div class="mt-3">
        <button class="btn btn-save" id="save-bracket">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Ç–∫—É</button>
          <button class="btn btn-secondary ms-2" id="advance-round">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</button>
          <button class="btn btn-info ms-2" id="complete-matches">–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–∞—Ç—á–∏</button>
          <button class="btn btn-warning ms-2" id="reset-bracket">–°–±—Ä–æ—Å–∏—Ç—å —Å–µ—Ç–∫—É</button>
        </div>
      </div>
      <a href="/admin.html" class="btn btn-secondary w-100 mt-4">–ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    if (!localStorage.getItem('admin-auth')) {
      window.location.href = '/login.html';
    }
    let tournaments = [], sports = [], fighters = [], selectedFighters = [], bracket = null, loadedBracket = null;
    // –ü–æ–ª—É—á–µ–Ω–∏–µ bracketId –∏–∑ URL
    function getBracketIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('bracketId');
    }
    async function loadTournamentsAndSports() {
      const tRes = await fetch('/api/tournaments');
      tournaments = await tRes.json();
      const sRes = await fetch('/api/sports');
      sports = await sRes.json();
      const tSel = document.getElementById('select-tournament');
      tSel.innerHTML = tournaments.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      const sSel = document.getElementById('select-sport');
      sSel.innerHTML = sports.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
    }
    async function loadBracketById(bracketId) {
      const res = await fetch('/api/brackets');
      const all = await res.json();
      loadedBracket = all.find(b => b.id == bracketId);
      if (!loadedBracket) return;
      // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º—É
      document.getElementById('select-tournament').value = loadedBracket.tournamentId;
      document.getElementById('select-sport').value = loadedBracket.sport;
      document.getElementById('select-weight').value = loadedBracket.weight;
      document.getElementById('select-gender').value = loadedBracket.gender;
      // –ë–æ–π—Ü—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–≤—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö)
      const resF = await fetch(`/api/fighters?sport=${encodeURIComponent(loadedBracket.sport)}&weight=${encodeURIComponent(loadedBracket.weight)}&gender=${encodeURIComponent(loadedBracket.gender)}`);
      fighters = await resF.json();
      selectedFighters = loadedBracket.fighters.map(f => f.id);
      bracket = loadedBracket.bracket && loadedBracket.bracket.rounds ? loadedBracket.bracket : { ...loadedBracket.bracket, rounds: loadedBracket.bracket.rounds || [] };
      renderFighterList();
      document.getElementById('fighters-block').style.display = '';
      document.getElementById('bracket-block').style.display = '';
      renderBracketTable();
    }
    // --- INIT ---
    (async function init() {
      await loadTournamentsAndSports();
      const bracketId = getBracketIdFromUrl();
      if (bracketId) {
        await loadBracketById(bracketId);
      }
    })();
    // –ó–∞–≥—Ä—É–∑–∫–∞ –±–æ–π—Ü–æ–≤ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º
    document.getElementById('load-fighters').onclick = async function() {
      const sport = document.getElementById('select-sport').value;
      const weight = document.getElementById('select-weight').value;
      const gender = document.getElementById('select-gender').value;
      const res = await fetch(`/api/fighters?sport=${encodeURIComponent(sport)}&weight=${encodeURIComponent(weight)}&gender=${encodeURIComponent(gender)}`);
      fighters = await res.json();
      selectedFighters = [];
      renderFighterList();
      document.getElementById('fighters-block').style.display = '';
      document.getElementById('bracket-block').style.display = 'none';
    };
    function renderFighterList() {
      const list = document.getElementById('fighter-list');
      list.innerHTML = '';
      fighters.forEach(f => {
        const div = document.createElement('div');
        div.className = 'fighter-item' + (selectedFighters.includes(f.id) ? ' selected' : '');
        div.textContent = `${f.name} (${f.club || '-'})`;
        div.onclick = () => {
          if (selectedFighters.includes(f.id)) {
            selectedFighters = selectedFighters.filter(id => id !== f.id);
          } else {
            selectedFighters.push(f.id);
          }
          renderFighterList();
        };
        list.appendChild(div);
      });
    }
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞ —Å —É—á—ë—Ç–æ–º –∫–ª—É–±–æ–≤
    function generateFirstRoundNoTeammates(fighters) {
      // –ñ–∞–¥–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º: –ø–æ –∫—Ä—É–≥—É –±–µ—Ä—ë–º –±–æ–π—Ü–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–ª—É–±–æ–≤
      const pool = [...fighters];
      const pairs = [];
      while (pool.length > 1) {
        const f1 = pool.shift();
        let idx = pool.findIndex(f => f.club !== f1.club);
        if (idx === -1) idx = 0; // –µ—Å–ª–∏ –≤—Å–µ –∏–∑ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
        const f2 = pool.splice(idx, 1)[0];
        pairs.push([f1, f2]);
      }
      if (pool.length === 1) pairs.push([pool[0]]);
      return pairs;
    }
    // –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ç–∫–∏
    document.getElementById('generate-bracket').onclick = async function() {
      const selected = fighters.filter(f => selectedFighters.includes(f.id));
      if (selected.length < 2) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º –¥–≤—É—Ö –±–æ–π—Ü–æ–≤!');
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–∏
      bracket = generateTournamentBracket(selected);
      renderBracketTable();
      document.getElementById('bracket-block').style.display = '';
    };
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–∏
    function generateTournamentBracket(fighters) {
      const rounds = [];
      let currentFighters = [...fighters];
      
      // –ü–µ—Ä–≤—ã–π —Ä–∞—É–Ω–¥
      const firstRound = {
        matches: []
      };
      
      // –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—ã –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
      const pairs = generateFirstRoundNoTeammates(currentFighters);
      pairs.forEach(pair => {
        const match = {
          fighters: pair,
          result: null
        };
        firstRound.matches.push(match);
      });
      
      rounds.push(firstRound);
      
      // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—ã–µ —Ä–∞—É–Ω–¥—ã –¥–ª—è –±—É–¥—É—â–∏—Ö —ç—Ç–∞–ø–æ–≤
      let remainingFighters = currentFighters.length;
      while (remainingFighters > 1) {
        remainingFighters = Math.ceil(remainingFighters / 2);
        const nextRound = {
          matches: []
        };
        
        // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Ç—á–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞
        for (let i = 0; i < remainingFighters; i++) {
          nextRound.matches.push({
            fighters: [null, null],
            result: null
          });
        }
        
        rounds.push(nextRound);
      }
      
      return { rounds };
    }
    // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö —Ä–∞—É–Ω–¥–æ–≤
    function renderBracketVisual() {
      const container = document.getElementById('bracket-visual');
      container.innerHTML = '';
      let rounds = bracket.rounds;

      // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ä–∞—É–Ω–¥—ã –∏–∑ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –≤—Å–µ –ø–∞—Ä—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã
      for (let r = 0; r < rounds.length; r++) {
        const curr = rounds[r];
        if (
          r === rounds.length - 1 &&
          curr.every(pair => (pair.length === 2 ? typeof pair._winner === 'number' : true)) &&
          curr.length > 1
        ) {
          const winners = curr.map(pair => (pair.length === 2 ? pair[pair._winner] : pair[0]));
          const nextRound = [];
          for (let i = 0; i < winners.length; i += 2) {
            if (i + 1 < winners.length) nextRound.push([winners[i], winners[i + 1]]);
            else nextRound.push([winners[i]]);
          }
          rounds.push(nextRound);
        }
      }

      // –ú–∞–ª—ã–π —Ñ–∏–Ω–∞–ª (–±–æ–π –∑–∞ 3 –º–µ—Å—Ç–æ)
      let bronzePair = null;
      if (
        rounds.length >= 3 &&
        rounds[rounds.length - 2].length === 2 &&
        rounds[rounds.length - 2].every(pair => typeof pair._winner === 'number') &&
        !bracket.bronzePair // —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      ) {
        const semi = rounds[rounds.length - 2];
        const losers = semi.map(pair => pair[1 - pair._winner]);
        if (losers.length === 2) {
          bronzePair = losers;
          bracket.bronzePair = bronzePair; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±—ä–µ–∫—Ç–µ —Å–µ—Ç–∫–∏
        }
      } else if (bracket.bronzePair) {
        bronzePair = bracket.bronzePair;
      }

      // --- –†–µ–Ω–¥–µ—Ä –¥–µ—Ä–µ–≤–∞ ---
      const bracketContainer = document.createElement('div');
      bracketContainer.className = 'bracket-container';

      rounds.forEach((round, roundIndex) => {
        const roundDiv = document.createElement('div');
        roundDiv.className = 'round';
        roundDiv.innerHTML = `<h5>${roundIndex === rounds.length - 1 ? '–§–∏–Ω–∞–ª' : `–†–∞—É–Ω–¥ ${roundIndex + 1}`}</h5>`;

        const matchesContainer = document.createElement('div');
        matchesContainer.style.display = 'flex';
        matchesContainer.style.flexDirection = 'column';
        matchesContainer.style.justifyContent = 'space-around';
        matchesContainer.style.flexGrow = '1';

        round.forEach((pair, pairIndex) => {
          const matchDiv = document.createElement('div');
          matchDiv.className = 'match';

          const pairContainer = document.createElement('div');
          pairContainer.className = 'pair-container';

          if (Array.isArray(pair)) {
            pair.forEach((f, idx) => {
              if (!f) return;
              const div = document.createElement('div');
              div.className = 'fighter-item' + (pair._winner === idx ? ' winner' : '');
              div.textContent = f.name + (f.club ? ` (${f.club})` : '');
              
              if (pair.length === 2 && pair[0] && pair[1]) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm ms-2 ' + (pair._winner === idx ? 'btn-danger' : 'btn-outline-danger');
                btn.textContent = 'üëë';
                btn.disabled = typeof pair._winner === 'number';
                btn.onclick = () => {
                  pair._winner = idx;
                  renderBracketVisual();
                };
                div.appendChild(btn);
              }
              pairContainer.appendChild(div);
            });

            if (pair.length === 1) {
              const placeholder = document.createElement('div');
              placeholder.className = 'fighter-item bye';
              placeholder.textContent = '(–±–µ–∑ –ø–∞—Ä—ã)';
              pairContainer.appendChild(placeholder);
            }
          }
          matchDiv.appendChild(pairContainer);

          if (roundIndex < rounds.length - 1) {
            const connector = document.createElement('div');
            connector.className = 'connector';
            connector.innerHTML = `<div class="line-h"></div><div class="line-v"></div>`;
            matchDiv.appendChild(connector);
          }
          matchesContainer.appendChild(matchDiv);
        });
        roundDiv.appendChild(matchesContainer);
        bracketContainer.appendChild(roundDiv);
      });
      container.appendChild(bracketContainer);

      // --- –†–µ–Ω–¥–µ—Ä –±–æ—è –∑–∞ 3 –º–µ—Å—Ç–æ ---
      if (bronzePair) {
        const bronzeContainer = document.createElement('div');
        bronzeContainer.className = 'bronze-container';
        bronzeContainer.innerHTML = '<h5>–ë–æ–π –∑–∞ 3 –º–µ—Å—Ç–æ</h5>';
        
        const pairContainer = document.createElement('div');
        pairContainer.className = 'pair-container';
        
        bronzePair.forEach((f, idx) => {
           if (!f) return;
            const div = document.createElement('div');
            div.className = 'fighter-item' + (bronzePair._winner === idx ? ' winner' : '');
            div.textContent = f.name + (f.club ? ` (${f.club})` : '');

            if (bronzePair.length === 2) {
              const btn = document.createElement('button');
              btn.className = 'btn btn-sm ms-2 ' + (bronzePair._winner === idx ? 'btn-danger' : 'btn-outline-danger');
              btn.textContent = 'üëë';
              btn.disabled = typeof bronzePair._winner === 'number';
              btn.onclick = () => {
                bronzePair._winner = idx;
                renderBracketVisual();
              };
              div.appendChild(btn);
            }
            pairContainer.appendChild(div);
        });
        bronzeContainer.appendChild(pairContainer);
        container.appendChild(bronzeContainer);
      }
    }

    // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–∏ —Å SVG-—Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—è–º–∏
    function renderBracketTable() {
      const container = document.getElementById('bracket-visual');
      const svg = document.getElementById('bracket-connectors');
      container.innerHTML = '';
      svg.innerHTML = '';
      
      if (!bracket || !bracket.rounds || bracket.rounds.length === 0) {
        container.innerHTML = '<p>–°–µ—Ç–∫–∞ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞</p>';
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–∞—É–Ω–¥–æ–≤
      const bracketContainer = document.createElement('div');
      bracketContainer.className = 'bracket-container';
      container.appendChild(bracketContainer);
      
      // –°–æ–∑–¥–∞–µ–º —Ä–∞—É–Ω–¥—ã
      bracket.rounds.forEach((round, roundIndex) => {
        const roundDiv = document.createElement('div');
        roundDiv.className = 'round';
        
        const roundTitle = document.createElement('div');
        roundTitle.className = 'round-title';
        roundTitle.textContent = `–†–∞—É–Ω–¥ ${roundIndex + 1}`;
        roundDiv.appendChild(roundTitle);
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ç—á–∏ –≤ —Ä–∞—É–Ω–¥–µ
        round.matches.forEach((match, matchIndex) => {
          const matchDiv = document.createElement('div');
          matchDiv.className = 'match';
          if (match.winner !== undefined || match.result) {
            matchDiv.classList.add('completed');
          }
          matchDiv.dataset.roundIndex = roundIndex;
          matchDiv.dataset.matchIndex = matchIndex;
          
          // –î–æ–±–∞–≤–ª—è–µ–º –±–æ–π—Ü–æ–≤ –≤ –º–∞—Ç—á
          match.fighters.forEach((fighter, fighterIndex) => {
            if (fighter) {
              const fighterDiv = document.createElement('div');
              fighterDiv.className = 'bracket-fighter';
              fighterDiv.draggable = true;
              fighterDiv.dataset.fighterId = fighter.id;
              fighterDiv.dataset.fighterIndex = fighterIndex;
              fighterDiv.textContent = fighter.name;
              
              if (fighter.winner) {
                fighterDiv.classList.add('winner');
              }
              if (fighter.by) {
                fighterDiv.classList.add('by');
                fighterDiv.textContent = 'BYE';
              }
              
              // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
              addDragHandlers(fighterDiv, matchDiv);
              
              matchDiv.appendChild(fighterDiv);
            } else {
              // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é —è—á–µ–π–∫—É –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
              const emptyDiv = document.createElement('div');
              emptyDiv.className = 'bracket-fighter empty-slot';
              emptyDiv.textContent = '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞';
              emptyDiv.style.opacity = '0.5';
              emptyDiv.style.borderStyle = 'dashed';
              emptyDiv.dataset.fighterIndex = fighterIndex;
              
              // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫
              addEmptySlotHandlers(emptyDiv, matchDiv);
              
              matchDiv.appendChild(emptyDiv);
            }
          });
          
          // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (–º–∏–Ω–∏–º—É–º 2)
          const currentFighters = match.fighters.filter(f => f !== null).length;
          const emptySlots = Math.max(0, 2 - currentFighters);
          
          for (let i = 0; i < emptySlots; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'bracket-fighter empty-slot';
            emptyDiv.textContent = '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞';
            emptyDiv.style.opacity = '0.5';
            emptyDiv.style.borderStyle = 'dashed';
            emptyDiv.dataset.fighterIndex = match.fighters.length + i;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫
            addEmptySlotHandlers(emptyDiv, matchDiv);
            
            matchDiv.appendChild(emptyDiv);
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –º–∞—Ç—á–µ 2 –±–æ–π—Ü–∞)
          const activeFighters = match.fighters.filter(f => f && !f.by);
          if (activeFighters.length === 2 && !match.winner) {
            const winnerButtonsDiv = document.createElement('div');
            winnerButtonsDiv.className = 'winner-buttons';
            winnerButtonsDiv.style.marginTop = '10px';
            winnerButtonsDiv.style.textAlign = 'center';
            
            activeFighters.forEach((fighter, index) => {
              const button = document.createElement('button');
              button.className = 'btn btn-sm btn-success me-2';
              button.textContent = `–ü–æ–±–µ–¥–∞: ${fighter.name}`;
              button.onclick = () => setMatchWinner(roundIndex, matchIndex, index);
              winnerButtonsDiv.appendChild(button);
            });
            
            matchDiv.appendChild(winnerButtonsDiv);
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–º –º–∞—Ç—á–µ
          if (match.winner !== undefined) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'match-result';
            resultDiv.textContent = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${activeFighters[match.winner]?.name || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}`;
            resultDiv.style.color = '#e10600';
            resultDiv.style.fontWeight = 'bold';
            resultDiv.style.marginTop = '10px';
            matchDiv.appendChild(resultDiv);
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞
          if (match.result) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'match-result';
            resultDiv.textContent = match.result;
            resultDiv.style.color = '#e10600';
            resultDiv.style.fontWeight = 'bold';
            resultDiv.style.marginTop = '10px';
            matchDiv.appendChild(resultDiv);
          }
          
          roundDiv.appendChild(matchDiv);
        });
        
        container.appendChild(roundDiv);
      });
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    function addDragHandlers(fighterElement, matchElement) {
      // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      fighterElement.removeEventListener('dragstart', handleDragStart);
      fighterElement.removeEventListener('dragend', handleDragEnd);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      fighterElement.addEventListener('dragstart', handleDragStart);
      fighterElement.addEventListener('dragend', handleDragEnd);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–∞—Ç—á–∞
      matchElement.removeEventListener('dragover', handleDragOver);
      matchElement.removeEventListener('dragleave', handleDragLeave);
      matchElement.removeEventListener('drop', handleDrop);
      
      matchElement.addEventListener('dragover', handleDragOver);
      matchElement.addEventListener('dragleave', handleDragLeave);
      matchElement.addEventListener('drop', handleDrop);
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    function handleDragStart(e) {
      console.log('–ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è:', this.dataset.fighterId);
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', JSON.stringify({
        fighterId: this.dataset.fighterId,
        fighterIndex: this.dataset.fighterIndex,
        roundIndex: this.closest('.bracket-match').dataset.roundIndex,
        matchIndex: this.closest('.bracket-match').dataset.matchIndex
      }));
    }
    
    function handleDragEnd(e) {
      console.log('–ö–æ–Ω–µ—Ü –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
      this.classList.remove('dragging');
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      this.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      
      console.log('Drop event triggered');
      
      try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        const targetRoundIndex = parseInt(this.dataset.roundIndex);
        const targetMatchIndex = parseInt(this.dataset.matchIndex);
        
        console.log('Moving fighter:', data, 'to round:', targetRoundIndex, 'match:', targetMatchIndex);
        
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –±–æ–π—Ü–∞
        moveFighter(data, targetRoundIndex, targetMatchIndex);
      } catch (error) {
        console.error('Error in drop handler:', error);
      }
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫
    function addEmptySlotHandlers(emptyElement, matchElement) {
      // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      emptyElement.removeEventListener('dragover', handleEmptyDragOver);
      emptyElement.removeEventListener('dragleave', handleEmptyDragLeave);
      emptyElement.removeEventListener('drop', handleEmptyDrop);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      emptyElement.addEventListener('dragover', handleEmptyDragOver);
      emptyElement.addEventListener('dragleave', handleEmptyDragLeave);
      emptyElement.addEventListener('drop', handleEmptyDrop);
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫
    function handleEmptyDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      this.classList.add('drag-over');
      this.style.backgroundColor = '#e1060033';
      console.log('Empty slot drag over:', this.dataset.fighterIndex);
    }
    
    function handleEmptyDragLeave(e) {
      this.classList.remove('drag-over');
      this.style.backgroundColor = '';
      console.log('Empty slot drag leave');
    }
    
    function handleEmptyDrop(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      this.style.backgroundColor = '';
      
      console.log('Empty slot drop event triggered');
      
      try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        const targetRoundIndex = parseInt(this.closest('.bracket-match').dataset.roundIndex);
        const targetMatchIndex = parseInt(this.closest('.bracket-match').dataset.matchIndex);
        const targetFighterIndex = parseInt(this.dataset.fighterIndex);
        
        console.log('Moving fighter to position:', data, 'to round:', targetRoundIndex, 'match:', targetMatchIndex, 'position:', targetFighterIndex);
        
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –±–æ–π—Ü–∞ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
        moveFighterToPosition(data, targetRoundIndex, targetMatchIndex, targetFighterIndex);
      } catch (error) {
        console.error('Error in empty slot drop handler:', error);
      }
    }
    
    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–æ–π—Ü–∞ –≤ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–µ
    function moveFighter(data, targetRoundIndex, targetMatchIndex) {
      console.log('moveFighter called with:', data, 'target:', targetRoundIndex, targetMatchIndex);
      
      const sourceRoundIndex = parseInt(data.roundIndex);
      const sourceMatchIndex = parseInt(data.matchIndex);
      const fighterId = parseInt(data.fighterId);
      
      console.log('Source:', sourceRoundIndex, sourceMatchIndex, 'Target:', targetRoundIndex, targetMatchIndex);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –±–æ–π—Ü–∞ –≤ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ (–ù–ï —É–¥–∞–ª—è–µ–º –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ)
      if (bracket.rounds[targetRoundIndex] && bracket.rounds[targetRoundIndex].matches[targetMatchIndex]) {
        const targetMatch = bracket.rounds[targetRoundIndex].matches[targetMatchIndex];
        const fighter = fighters.find(f => f.id == fighterId);
        
        if (!fighter) {
          console.error('Fighter not found:', fighterId);
          return;
        }
        
        console.log('Moving fighter:', fighter.name);
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –≤ –º–∞—Ç—á–µ
        let freeIndex = targetMatch.fighters.findIndex(f => f === null);
        if (freeIndex === -1) {
          freeIndex = targetMatch.fighters.length;
          targetMatch.fighters.push(null);
        }
        
        targetMatch.fighters[freeIndex] = fighter;
        console.log('Fighter placed at index:', freeIndex);
        
        // –ï—Å–ª–∏ –±–æ–µ—Ü –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø, –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–±–µ–¥—É
        if (targetRoundIndex > sourceRoundIndex) {
          console.log(`–ë–æ–µ—Ü ${fighter.name} –ø–µ—Ä–µ–º–µ—â–µ–Ω –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø`);
          
          // –ó–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–±–µ–¥—É –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
          handleDragToNextRound(fighterId, sourceRoundIndex, sourceMatchIndex);
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–≤–∏–≥–∞–µ–º –±–æ–π—Ü–∞ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
          advanceFighterToNextRound(fighterId, targetRoundIndex, targetMatchIndex);
        }
      } else {
        console.error('Target match not found:', targetRoundIndex, targetMatchIndex);
      }
      
      // –û—á–∏—â–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–µ—Ç–∫—É
      cleanDuplicateFighters();
      renderBracketTable();
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –±–æ–π—Ü–∞ –∏–∑ –≤—Å–µ—Ö –º–∞—Ç—á–µ–π (–∏–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
    function removeFighterFromAllMatches(fighterId) {
      bracket.rounds.forEach(round => {
        round.matches.forEach(match => {
          match.fighters.forEach((fighter, index) => {
            if (fighter && fighter.id == fighterId) {
              match.fighters[index] = null;
            }
          });
        });
      });
    }
    
    // –û—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –±–æ–π—Ü–æ–≤ –≤ —Å–µ—Ç–∫–µ
    function cleanDuplicateFighters() {
      const fighterPositions = new Map(); // fighterId -> {roundIndex, matchIndex, fighterIndex}
      
      bracket.rounds.forEach((round, roundIndex) => {
        round.matches.forEach((match, matchIndex) => {
          match.fighters.forEach((fighter, fighterIndex) => {
            if (fighter) {
              const fighterId = fighter.id;
              
              if (fighterPositions.has(fighterId)) {
                // –ë–æ–µ—Ü —É–∂–µ –µ—Å—Ç—å –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ, —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç
                console.log(`–£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç –±–æ–π—Ü–∞ ${fighter.name} –∏–∑ —Ä–∞—É–Ω–¥–∞ ${roundIndex + 1}`);
                match.fighters[fighterIndex] = null;
              } else {
                // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –±–æ–π—Ü–∞
                fighterPositions.set(fighterId, {
                  roundIndex,
                  matchIndex,
                  fighterIndex
                });
              }
            }
          });
        });
      });
    }
    
    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–æ–π—Ü–∞ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
    function moveFighterToPosition(data, targetRoundIndex, targetMatchIndex, targetFighterIndex) {
      console.log('moveFighterToPosition called with:', data, 'target:', targetRoundIndex, targetMatchIndex, 'position:', targetFighterIndex);
      
      const sourceRoundIndex = parseInt(data.roundIndex);
      const sourceMatchIndex = parseInt(data.matchIndex);
      const fighterId = parseInt(data.fighterId);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –±–æ–π—Ü–∞ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–æ–∑–∏—Ü–∏—é (–ù–ï —É–¥–∞–ª—è–µ–º –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ)
      if (bracket.rounds[targetRoundIndex] && bracket.rounds[targetRoundIndex].matches[targetMatchIndex]) {
        const targetMatch = bracket.rounds[targetRoundIndex].matches[targetMatchIndex];
        const fighter = fighters.find(f => f.id == fighterId);
        
        if (!fighter) {
          console.error('Fighter not found:', fighterId);
          return;
        }
        
        console.log('Moving fighter to position:', fighter.name, 'at index:', targetFighterIndex);
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–∞—Å—Å–∏–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–π
        while (targetMatch.fighters.length <= targetFighterIndex) {
          targetMatch.fighters.push(null);
        }
        
        targetMatch.fighters[targetFighterIndex] = fighter;
        console.log('Fighter placed at position:', targetFighterIndex);
        
        // –ï—Å–ª–∏ –±–æ–µ—Ü –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø, –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–±–µ–¥—É
        if (targetRoundIndex > sourceRoundIndex) {
          console.log(`–ë–æ–µ—Ü ${fighter.name} –ø–µ—Ä–µ–º–µ—â–µ–Ω –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø`);
          
          // –ó–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–±–µ–¥—É –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
          handleDragToNextRound(fighterId, sourceRoundIndex, sourceMatchIndex);
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–≤–∏–≥–∞–µ–º –±–æ–π—Ü–∞ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
          advanceFighterToNextRound(fighterId, targetRoundIndex, targetMatchIndex);
        }
      } else {
        console.error('Target match not found:', targetRoundIndex, targetMatchIndex);
      }
      
      // –û—á–∏—â–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–µ—Ç–∫—É
      cleanDuplicateFighters();
      renderBracketTable();
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ —Å –∑–∞—Å—á–µ—Ç–æ–º –ø–æ–±–µ–¥—ã
    async function handleDragToNextRound(fighterId, sourceRoundIndex, sourceMatchIndex) {
      try {
        const sourceMatch = bracket.rounds[sourceRoundIndex].matches[sourceMatchIndex];
        const fighter = fighters.find(f => f.id == fighterId);
        
        if (!fighter || !sourceMatch) return;
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –º–∞—Ç—á–µ
        const opponent = sourceMatch.fighters.find(f => f && f.id != fighterId);
        
        if (opponent) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ—Ä–¥—ã: –ø–µ—Ä–µ—Ç–∞—â–µ–Ω–Ω—ã–π –±–æ–µ—Ü –ø–æ–±–µ–∂–¥–∞–µ—Ç, —Å–æ–ø–µ—Ä–Ω–∏–∫ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç
          await fetch('/api/fighters/update-records', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              winnerId: fighterId,
              loserId: opponent.id,
              fightDate: new Date().toISOString(),
              tournamentName: document.getElementById('select-tournament').value || '–¢—É—Ä–Ω–∏—Ä',
              sport: document.getElementById('select-sport').value || '–¢—Ö—ç–∫–≤–æ–Ω–¥–æ',
              weight: document.getElementById('select-weight').value || 70,
              round: `–†–∞—É–Ω–¥ ${sourceRoundIndex + 1}`
            })
          });
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ–π—Ü–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
          fighter.wins = (fighter.wins || 0) + 1;
          opponent.losses = (opponent.losses || 0) + 1;
          
          // –ü–æ–º–µ—á–∞–µ–º –º–∞—Ç—á –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π
          sourceMatch.winner = sourceMatch.fighters.findIndex(f => f && f.id == fighterId);
          sourceMatch.result = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${fighter.name}`;
          
          console.log(`–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ: ${fighter.name} –ø–æ–±–µ–∂–¥–∞–µ—Ç ${opponent.name} –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø`);
        } else {
          // –ï—Å–ª–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –Ω–µ—Ç (–æ–¥–∏–Ω –±–æ–µ—Ü), –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ—á–∞–µ–º –º–∞—Ç—á –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π
          sourceMatch.winner = sourceMatch.fighters.findIndex(f => f && f.id == fighterId);
          sourceMatch.result = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${fighter.name}`;
          
          console.log(`–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ: ${fighter.name} –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø (–±–µ–∑ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞)`);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è:', error);
      }
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –±–æ–π—Ü–∞ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
    function advanceFighterToNextRound(fighterId, targetRoundIndex, targetMatchIndex) {
      const fighter = fighters.find(f => f.id == fighterId);
      if (!fighter) return;
      
      // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ –ø–æ—Å–ª–µ —Ü–µ–ª–µ–≤–æ–≥–æ
      const nextRoundIndex = targetRoundIndex + 1;
      if (nextRoundIndex < bracket.rounds.length) {
        const nextRound = bracket.rounds[nextRoundIndex];
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ä–∞—É–Ω–¥–µ
        let freeMatch = nextRound.matches.find(match => 
          match.fighters.some(f => f === null)
        );
        
        if (freeMatch) {
          const freeIndex = freeMatch.fighters.findIndex(f => f === null);
          if (freeIndex !== -1) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ–µ—Ü –µ—â–µ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —ç—Ç–æ–º –º–∞—Ç—á–µ
            const alreadyExists = freeMatch.fighters.some(f => f && f.id == fighterId);
            if (!alreadyExists) {
              freeMatch.fighters[freeIndex] = fighter;
              console.log(`${fighter.name} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç –≤ —Ä–∞—É–Ω–¥ ${nextRoundIndex + 1}`);
            }
          }
        }
      }
    }
    
    // –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –º–∞—Ç—á–∞ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
    function advanceWinnerToNextRound(winner, currentRoundIndex) {
      const nextRoundIndex = currentRoundIndex + 1;
      if (nextRoundIndex < bracket.rounds.length) {
        const nextRound = bracket.rounds[nextRoundIndex];
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ä–∞—É–Ω–¥–µ
        let freeMatch = nextRound.matches.find(match => 
          match.fighters.some(f => f === null)
        );
        
        if (freeMatch) {
          const freeIndex = freeMatch.fighters.findIndex(f => f === null);
          if (freeIndex !== -1) {
            freeMatch.fighters[freeIndex] = winner;
            console.log(`–ü–æ–±–µ–¥–∏—Ç–µ–ª—å ${winner.name} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç –≤ —Ä–∞—É–Ω–¥ ${nextRoundIndex + 1}`);
          }
        }
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –±–æ–π—Ü–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è)
    async function handleFighterAdvancement(fighterId, opponentId, isWinner, roundNumber = 1) {
      try {
        if (!isWinner) return; // –ó–∞—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å
        
        const fighter = fighters.find(f => f.id == fighterId);
        const opponent = fighters.find(f => f.id == opponentId);
        
        if (!fighter || !opponent) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ—Ä–¥—ã: –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–±–µ–¥—É, –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏–π - –ø–æ—Ä–∞–∂–µ–Ω–∏–µ
        await fetch('/api/fighters/update-records', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            winnerId: fighterId,
            loserId: opponentId,
            fightDate: new Date().toISOString(),
            tournamentName: document.getElementById('select-tournament').value || '–¢—É—Ä–Ω–∏—Ä',
            sport: document.getElementById('select-sport').value || '–ë–æ–∫—Å',
            weight: document.getElementById('select-weight').value || 70,
            round: `–†–∞—É–Ω–¥ ${roundNumber}`
          })
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ–π—Ü–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
        fighter.wins = (fighter.wins || 0) + 1;
        opponent.losses = (opponent.losses || 0) + 1;
        
        console.log(`${fighter.name} –ø–æ–±–µ–∂–¥–∞–µ—Ç ${opponent.name} –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø`);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤:', error);
      }
    }
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –º–∞—Ç—á–∞
    async function setMatchWinner(roundIndex, matchIndex, winnerIndex) {
      try {
        const match = bracket.rounds[roundIndex].matches[matchIndex];
        const activeFighters = match.fighters.filter(f => f && !f.by);
        
        if (activeFighters.length !== 2) return;
        
        const winner = activeFighters[winnerIndex];
        const loser = activeFighters[1 - winnerIndex];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ—Ä–¥—ã —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        await handleFighterAdvancement(winner.id, loser.id, true, roundIndex + 1);
        
        // –ü–æ–º–µ—á–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤ –º–∞—Ç—á–µ
        match.winner = winnerIndex;
        match.result = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner.name}`;
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–≤–∏–≥–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
        advanceWinnerToNextRound(winner, roundIndex);
        
        console.log(`–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à–µ–Ω: ${winner.name} –ø–æ–±–µ–∂–¥–∞–µ—Ç ${loser.name}`);
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–µ—Ç–∫—É
        renderBracketTable();
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è:', error);
      }
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –±–æ–π—Ü–æ–≤ –±–µ–∑ –ø–∞—Ä—ã
    function advanceByes() {
      if (!bracket || !bracket.rounds) return;
      
      bracket.rounds.forEach((round, roundIndex) => {
        round.matches.forEach((match, matchIndex) => {
          const activeFighters = match.fighters.filter(f => f && !f.by);
          
          // –ï—Å–ª–∏ –≤ –º–∞—Ç—á–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –±–æ–µ—Ü, –ø—Ä–æ–¥–≤–∏–≥–∞–µ–º –µ–≥–æ
          if (activeFighters.length === 1) {
            const nextRound = bracket.rounds[roundIndex + 1];
            if (nextRound) {
              // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π –º–∞—Ç—á –¥–ª—è —ç—Ç–æ–≥–æ –±–æ–π—Ü–∞
              const nextMatch = nextRound.matches.find(m => 
                m.fighters.some(f => f === null)
              );
              
              if (nextMatch) {
                const freeIndex = nextMatch.fighters.findIndex(f => f === null);
                if (freeIndex !== -1) {
                  nextMatch.fighters[freeIndex] = activeFighters[0];
                  // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ BYE –≤ —Ç–µ–∫—É—â–µ–º —Ä–∞—É–Ω–¥–µ
                  match.fighters.forEach(f => {
                    if (f && f.id === activeFighters[0].id) {
                      f.by = true;
                    }
                  });
                  
                  console.log(`${activeFighters[0].name} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç –≤ —Ä–∞—É–Ω–¥ ${roundIndex + 2}`);
                }
              }
            }
          }
        });
      });
    }
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
    document.getElementById('save-bracket').onclick = async function() {
      const tournamentId = document.getElementById('select-tournament').value;
      const sport = document.getElementById('select-sport').value;
      const weight = document.getElementById('select-weight').value;
      const gender = document.getElementById('select-gender').value;
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º id –±–æ–π—Ü–æ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–µ—Ç–∫–∏
      const fightersData = fighters.filter(f => selectedFighters.includes(f.id));
      await fetch('/api/brackets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tournamentId,
          sport,
          weight,
          gender,
          fighters: fightersData,
          bracket
        })
      });
      alert('–°–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
    };
    
    // –°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
    document.getElementById('advance-round').onclick = function() {
      advanceByes();
      renderBracketTable();
    };
    
    // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π
    document.getElementById('complete-matches').onclick = function() {
      if (confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ –º–∞—Ç—á–∏? –≠—Ç–æ –∑–∞—Å—á–∏—Ç–∞–µ—Ç –ø–æ–±–µ–¥—ã/–ø–æ—Ä–∞–∂–µ–Ω–∏—è –±–æ–π—Ü–∞–º.')) {
        completeAllMatches();
      }
    };
    
    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞—Ç—á–µ–π
    async function completeAllMatches() {
      if (!bracket || !bracket.rounds) return;
      
      for (let roundIndex = 0; roundIndex < bracket.rounds.length; roundIndex++) {
        const round = bracket.rounds[roundIndex];
        for (let matchIndex = 0; matchIndex < round.matches.length; matchIndex++) {
          const match = round.matches[matchIndex];
          const activeFighters = match.fighters.filter(f => f && !f.by);
          
          // –ï—Å–ª–∏ –≤ –º–∞—Ç—á–µ 2 –±–æ–π—Ü–∞ –∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
          if (activeFighters.length === 2 && match.winner === undefined) {
            // –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é –ª–æ–≥–∏–∫—É)
            const winnerIndex = Math.random() < 0.5 ? 0 : 1;
            const winner = activeFighters[winnerIndex];
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
            match.winner = winnerIndex;
            match.result = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner.name}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ—Ä–¥—ã
            await handleFighterAdvancement(winner.id, activeFighters[1 - winnerIndex].id, true, roundIndex + 1);
            
            // –ü—Ä–æ–¥–≤–∏–≥–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
            advanceWinnerToNextRound(winner, roundIndex);
          }
        }
      }
      
      renderBracketTable();
    }
    
    // –°–±—Ä–æ—Å —Å–µ—Ç–∫–∏
    document.getElementById('reset-bracket').onclick = function() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä–Ω—É—é —Å–µ—Ç–∫—É?')) {
        bracket = null;
        renderBracketTable();
      }
    };

    document.getElementById('logout').onclick = function() {
      localStorage.removeItem('admin-auth');
      window.location.href = '/login.html';
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π (–¥–ª—è flex-—Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
    function drawConnectors() {
      const svg = document.getElementById('bracket-connectors');
      const container = document.getElementById('bracket-visual');
      const rounds = container.querySelectorAll('.round');
      
      if (rounds.length < 2) return;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã SVG
      const containerRect = container.getBoundingClientRect();
      svg.setAttribute('width', containerRect.width);
      svg.setAttribute('height', containerRect.height);
      
      // –†–∏—Å—É–µ–º —Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª–∏ –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏
      for (let i = 0; i < rounds.length - 1; i++) {
        const currentRound = rounds[i];
        const nextRound = rounds[i + 1];
        const currentMatches = currentRound.querySelectorAll('.match');
        const nextMatches = nextRound.querySelectorAll('.match');
        
        currentMatches.forEach((match, matchIndex) => {
          const nextMatchIndex = Math.floor(matchIndex / 2);
          if (nextMatchIndex < nextMatches.length) {
            const nextMatch = nextMatches[nextMatchIndex];
            
            const matchRect = match.getBoundingClientRect();
            const nextMatchRect = nextMatch.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            const startX = matchRect.right - containerRect.left;
            const startY = matchRect.top + matchRect.height / 2 - containerRect.top;
            const endX = nextMatchRect.left - containerRect.left;
            const endY = nextMatchRect.top + nextMatchRect.height / 2 - containerRect.top;
            
            const midX = (startX + endX) / 2;
            
            // –†–∏—Å—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –ª–∏–Ω–∏–∏
            drawSquareLine(startX, startY, endX, endY);
          }
        });
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –ª–∏–Ω–∏–π (–∏–∑ testbr.html)
    function drawSquareLine(x1, y1, x2, y2) {
      const svg = document.getElementById('bracket-connectors');
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      const midX = (x1 + x2) / 2;
      path.setAttribute('d', `M ${x1} ${y1} H ${midX} V ${y2} H ${x2}`);
      path.setAttribute('stroke', '#e10600');
      path.setAttribute('stroke-width', '2');
      path.setAttribute('fill', 'none');
      path.setAttribute('class', 'connector-line');
      svg.appendChild(path);
    }
  </script>
</body>
</html> 